
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>app_heartbeat.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @file app_heartbeat.c</a>
<a name="ln3"> * @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln4"> * @date 2020-06-17</a>
<a name="ln5"> * @copyright Ruuvi Innovations Ltd, License BSD-3-Clause.</a>
<a name="ln6"> */</a>
<a name="ln7"> </a>
<a name="ln8">#include &quot;app_config.h&quot;</a>
<a name="ln9">#include &quot;app_comms.h&quot;</a>
<a name="ln10">#include &quot;app_heartbeat.h&quot;</a>
<a name="ln11">#include &quot;app_log.h&quot;</a>
<a name="ln12">#include &quot;app_sensor.h&quot;</a>
<a name="ln13">#include &quot;ruuvi_driver_error.h&quot;</a>
<a name="ln14">#include &quot;ruuvi_driver_sensor.h&quot;</a>
<a name="ln15">#include &quot;ruuvi_endpoint_5.h&quot;</a>
<a name="ln16">#include &quot;ruuvi_interface_communication.h&quot;</a>
<a name="ln17">#include &quot;ruuvi_interface_communication_radio.h&quot;</a>
<a name="ln18">#include &quot;ruuvi_interface_scheduler.h&quot;</a>
<a name="ln19">#include &quot;ruuvi_interface_timer.h&quot;</a>
<a name="ln20">#include &quot;ruuvi_interface_watchdog.h&quot;</a>
<a name="ln21">#include &quot;ruuvi_task_adc.h&quot;</a>
<a name="ln22">#include &quot;ruuvi_task_advertisement.h&quot;</a>
<a name="ln23">#include &quot;ruuvi_task_gatt.h&quot;</a>
<a name="ln24">#include &quot;ruuvi_task_nfc.h&quot;</a>
<a name="ln25"> </a>
<a name="ln26">static ri_timer_id_t heart_timer; //!&lt; Timer for updating data.</a>
<a name="ln27"> </a>
<a name="ln28">#ifndef CEEDLING</a>
<a name="ln29">static</a>
<a name="ln30">#endif</a>
<a name="ln31">uint16_t m_measurement_count; //!&lt; Increment on new samples.</a>
<a name="ln32"> </a>
<a name="ln33">static rd_status_t encode_to_5 (const rd_sensor_data_t * const data,</a>
<a name="ln34">                                ri_comm_message_t * const msg)</a>
<a name="ln35">{</a>
<a name="ln36">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln37">    uint8_t movement_count = (uint8_t) (app_sensor_event_count_get() &amp; 0xFEU);</a>
<a name="ln38">    re_5_data_t ep_data =</a>
<a name="ln39">    {</a>
<a name="ln40">        .accelerationx_g   = rd_sensor_data_parse (data, RD_SENSOR_ACC_X_FIELD),</a>
<a name="ln41">        .accelerationy_g   = rd_sensor_data_parse (data, RD_SENSOR_ACC_Y_FIELD),</a>
<a name="ln42">        .accelerationz_g   = rd_sensor_data_parse (data, RD_SENSOR_ACC_Z_FIELD),</a>
<a name="ln43">        .humidity_rh       = rd_sensor_data_parse (data, RD_SENSOR_HUMI_FIELD),</a>
<a name="ln44">        .pressure_pa       = rd_sensor_data_parse (data, RD_SENSOR_PRES_FIELD),</a>
<a name="ln45">        .temperature_c     = rd_sensor_data_parse (data, RD_SENSOR_TEMP_FIELD),</a>
<a name="ln46">        .address           = RE_5_INVALID_MAC,</a>
<a name="ln47">        .tx_power          = RE_5_INVALID_POWER,</a>
<a name="ln48">        .battery_v         = RE_5_INVALID_VOLTAGE,</a>
<a name="ln49">        .measurement_count = m_measurement_count,</a>
<a name="ln50">        .movement_count    = movement_count</a>
<a name="ln51">    };</a>
<a name="ln52">    err_code |= ri_radio_address_get (&amp;ep_data.address);</a>
<a name="ln53">    err_code |= ri_adv_tx_power_get (&amp;ep_data.tx_power);</a>
<a name="ln54">    err_code |= rt_adc_vdd_get (&amp;ep_data.battery_v);</a>
<a name="ln55">    re_5_encode (msg-&gt;data, &amp;ep_data);</a>
<a name="ln56">    msg-&gt;data_length = RE_5_DATA_LENGTH;</a>
<a name="ln57">    return err_code;</a>
<a name="ln58">}</a>
<a name="ln59"> </a>
<a name="ln60">static rd_status_t send_adv (ri_comm_message_t * const p_msg)</a>
<a name="ln61">{</a>
<a name="ln62">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln63">    const uint8_t repeat_count = app_comms_bleadv_send_count_get();</a>
<a name="ln64"> </a>
<a name="ln65">    if (APP_COMM_ADV_DISABLE != repeat_count)</a>
<a name="ln66">    {</a>
<a name="ln67">        if (APP_COMM_ADV_REPEAT_FOREVER == repeat_count)</a>
<a name="ln68">        {</a>
<a name="ln69">            p_msg-&gt;repeat_count = RI_COMM_MSG_REPEAT_FOREVER;</a>
<a name="ln70">        }</a>
<a name="ln71">        else</a>
<a name="ln72">        {</a>
<a name="ln73">            p_msg-&gt;repeat_count = repeat_count;</a>
<a name="ln74">        }</a>
<a name="ln75"> </a>
<a name="ln76">        err_code |= rt_adv_send_data (p_msg);</a>
<a name="ln77">    }</a>
<a name="ln78">    else</a>
<a name="ln79">    {</a>
<a name="ln80">        rt_adv_stop();</a>
<a name="ln81">    }</a>
<a name="ln82"> </a>
<a name="ln83">    return err_code;</a>
<a name="ln84">}</a>
<a name="ln85"> </a>
<a name="ln86">/**</a>
<a name="ln87"> * @brief When timer triggers, schedule reading sensors and sending data.</a>
<a name="ln88"> *</a>
<a name="ln89"> * @param[in] p_context Always NULL.</a>
<a name="ln90"> */</a>
<a name="ln91">#ifndef CEEDLING</a>
<a name="ln92">static</a>
<a name="ln93">#endif</a>
<a name="ln94">void heartbeat (void * p_event, uint16_t event_size)</a>
<a name="ln95">{</a>
<a name="ln96">    ri_comm_message_t msg = {0};</a>
<a name="ln97">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln98">    bool heartbeat_ok = false;</a>
<a name="ln99">    rd_sensor_data_t data = { 0 };</a>
<a name="ln100">    data.fields = app_sensor_available_data();</a>
<a name="ln101">    float data_values[rd_sensor_data_fieldcount (&amp;data)];</a>
<a name="ln102">    data.data = data_values;</a>
<a name="ln103">    app_sensor_get (&amp;data);</a>
<a name="ln104">    encode_to_5 (&amp;data, &amp;msg);</a>
<a name="ln105"> </a>
<a name="ln106">    if (RE_5_INVALID_SEQUENCE == ++m_measurement_count)</a>
<a name="ln107">    {</a>
<a name="ln108">        m_measurement_count = 0;</a>
<a name="ln109">    }</a>
<a name="ln110"> </a>
<a name="ln111">    err_code = send_adv (&amp;msg);</a>
<a name="ln112">    // Advertising should always be successful</a>
<a name="ln113">    RD_ERROR_CHECK (err_code, ~RD_ERROR_FATAL);</a>
<a name="ln114"> </a>
<a name="ln115">    if (RD_SUCCESS == err_code)</a>
<a name="ln116">    {</a>
<a name="ln117">        heartbeat_ok = true;</a>
<a name="ln118">    }</a>
<a name="ln119"> </a>
<a name="ln120">    // Cut endpoint 5 data to fit into GATT msg.</a>
<a name="ln121">    msg.data_length = 18;</a>
<a name="ln122">    // Gatt Link layer takes care of delivery.</a>
<a name="ln123">    msg.repeat_count = 1;</a>
<a name="ln124">    err_code = rt_gatt_send_asynchronous (&amp;msg);</a>
<a name="ln125"> </a>
<a name="ln126">    if (RD_SUCCESS == err_code)</a>
<a name="ln127">    {</a>
<a name="ln128">        heartbeat_ok = true;</a>
<a name="ln129">    }</a>
<a name="ln130"> </a>
<a name="ln131">    err_code = rt_nfc_send (&amp;msg);</a>
<a name="ln132"> </a>
<a name="ln133">    if (RD_SUCCESS == err_code)</a>
<a name="ln134">    {</a>
<a name="ln135">        heartbeat_ok = true;</a>
<a name="ln136">    }</a>
<a name="ln137"> </a>
<a name="ln138">    if (heartbeat_ok)</a>
<a name="ln139">    {</a>
<a name="ln140">        ri_watchdog_feed();</a>
<a name="ln141">    }</a>
<a name="ln142"> </a>
<a name="ln143">    err_code = app_log_process (&amp;data);</a>
<a name="ln144">    RD_ERROR_CHECK (err_code, ~RD_ERROR_FATAL);</a>
<a name="ln145">}</a>
<a name="ln146"> </a>
<a name="ln147">/**</a>
<a name="ln148"> * @brief When timer triggers, schedule reading sensors and sending data.</a>
<a name="ln149"> *</a>
<a name="ln150"> * @param[in] p_context Always NULL.</a>
<a name="ln151"> */</a>
<a name="ln152">#ifndef CEEDLING</a>
<a name="ln153">static</a>
<a name="ln154">#endif</a>
<a name="ln155">void schedule_heartbeat_isr (void * const p_context)</a>
<a name="ln156">{</a>
<a name="ln157">    ri_scheduler_event_put (NULL, 0U, &amp;heartbeat);</a>
<a name="ln158">}</a>
<a name="ln159"> </a>
<a name="ln160">rd_status_t app_heartbeat_init (void)</a>
<a name="ln161">{</a>
<a name="ln162">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln163"> </a>
<a name="ln164">    if ( (!ri_timer_is_init()) || (!ri_scheduler_is_init()))</a>
<a name="ln165">    {</a>
<a name="ln166">        err_code |= RD_ERROR_INVALID_STATE;</a>
<a name="ln167">    }</a>
<a name="ln168">    else</a>
<a name="ln169">    {</a>
<a name="ln170">        err_code |= ri_timer_create (&amp;heart_timer, RI_TIMER_MODE_REPEATED,</a>
<a name="ln171">                                     &amp;schedule_heartbeat_isr);</a>
<a name="ln172"> </a>
<a name="ln173">        if (RD_SUCCESS == err_code)</a>
<a name="ln174">        {</a>
<a name="ln175">            err_code |= ri_timer_start (heart_timer, APP_HEARTBEAT_INTERVAL_MS, NULL);</a>
<a name="ln176">        }</a>
<a name="ln177">    }</a>
<a name="ln178"> </a>
<a name="ln179">    return err_code;</a>
<a name="ln180">}</a>
<a name="ln181"> </a>
<a name="ln182">rd_status_t app_heartbeat_start (void)</a>
<a name="ln183">{</a>
<a name="ln184">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln185"> </a>
<a name="ln186">    if (NULL == heart_timer)</a>
<a name="ln187">    {</a>
<a name="ln188">        err_code |= RD_ERROR_INVALID_STATE;</a>
<a name="ln189">    }</a>
<a name="ln190">    else</a>
<a name="ln191">    {</a>
<a name="ln192">        heartbeat (NULL, 0);</a>
<a name="ln193">        err_code |= ri_timer_start (heart_timer, APP_HEARTBEAT_INTERVAL_MS, NULL);</a>
<a name="ln194">    }</a>
<a name="ln195"> </a>
<a name="ln196">    return err_code;</a>
<a name="ln197">}</a>
<a name="ln198"> </a>
<a name="ln199">rd_status_t app_heartbeat_stop (void)</a>
<a name="ln200">{</a>
<a name="ln201">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln202"> </a>
<a name="ln203">    if (NULL == heart_timer)</a>
<a name="ln204">    {</a>
<a name="ln205">        err_code |= RD_ERROR_INVALID_STATE;</a>
<a name="ln206">    }</a>
<a name="ln207">    else</a>
<a name="ln208">    {</a>
<a name="ln209">        err_code |= ri_timer_stop (heart_timer);</a>
<a name="ln210">    }</a>
<a name="ln211"> </a>
<a name="ln212">    return err_code;</a>
<a name="ln213">}</a>
<a name="ln214"> </a>
<a name="ln215">#ifdef CEEDLING</a>
<a name="ln216">// Give CEEDLING a handle to state of module.</a>
<a name="ln217">ri_timer_id_t * get_heart_timer (void)</a>
<a name="ln218">{</a>
<a name="ln219">    return &amp;heart_timer;</a>
<a name="ln220">}</a>
<a name="ln221">#endif</a>

</code></pre>
<div class="balloon" rel="56"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="106"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '==' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="108"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="117"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="121"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="123"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="128"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="135"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="92"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'event_size'.</p></div>
<div class="balloon" rel="92"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'p_event'.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
