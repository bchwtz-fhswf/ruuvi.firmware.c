
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>app_button.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">#include &quot;app_button.h&quot;</a>
<a name="ln2">#include &quot;app_comms.h&quot;</a>
<a name="ln3">#include &quot;app_heartbeat.h&quot;</a>
<a name="ln4">#include &quot;app_led.h&quot;</a>
<a name="ln5">#include &quot;app_log.h&quot;</a>
<a name="ln6">#include &quot;ruuvi_boards.h&quot;</a>
<a name="ln7">#include &quot;ruuvi_driver_error.h&quot;</a>
<a name="ln8">#include &quot;ruuvi_interface_flash.h&quot;</a>
<a name="ln9">#include &quot;ruuvi_interface_power.h&quot;</a>
<a name="ln10">#include &quot;ruuvi_interface_gpio.h&quot;</a>
<a name="ln11">#include &quot;ruuvi_interface_gpio_interrupt.h&quot;</a>
<a name="ln12">#include &quot;ruuvi_interface_log.h&quot;</a>
<a name="ln13">#include &quot;ruuvi_interface_scheduler.h&quot;</a>
<a name="ln14">#include &quot;ruuvi_interface_timer.h&quot;</a>
<a name="ln15">#include &quot;ruuvi_task_button.h&quot;</a>
<a name="ln16"> </a>
<a name="ln17">/**</a>
<a name="ln18"> * @addtogroup app_button</a>
<a name="ln19"> */</a>
<a name="ln20">/** @{ */</a>
<a name="ln21">/**</a>
<a name="ln22"> * @file app_button.c</a>
<a name="ln23"> * @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln24"> * @date 2020-02-12</a>
<a name="ln25"> * @copyright Ruuvi Innovations Ltd, license BSD-3-Clause.</a>
<a name="ln26"> */</a>
<a name="ln27"> </a>
<a name="ln28">#if RB_BUTTONS_NUMBER</a>
<a name="ln29"> </a>
<a name="ln30">#ifndef CEEDLING</a>
<a name="ln31">static</a>
<a name="ln32">#endif</a>
<a name="ln33">ri_timer_id_t m_button_timer;</a>
<a name="ln34"> </a>
<a name="ln35">#ifndef CEEDLING</a>
<a name="ln36">typedef struct</a>
<a name="ln37">{</a>
<a name="ln38">    unsigned int factory_reset : 1; //!&lt; Button should do a factory reset.</a>
<a name="ln39">} button_action_t;</a>
<a name="ln40">#endif</a>
<a name="ln41">#ifndef CEEDLING</a>
<a name="ln42">static</a>
<a name="ln43">#endif</a>
<a name="ln44">button_action_t m_button_action;</a>
<a name="ln45"> </a>
<a name="ln46">static inline void LOG (const char * const msg)</a>
<a name="ln47">{</a>
<a name="ln48">    ri_log (RI_LOG_LEVEL_INFO, msg);</a>
<a name="ln49">}</a>
<a name="ln50"> </a>
<a name="ln51">#ifndef CEEDLING</a>
<a name="ln52">static</a>
<a name="ln53">#endif</a>
<a name="ln54">void factory_reset (void * p_event_data, uint16_t event_size)</a>
<a name="ln55">{</a>
<a name="ln56">    app_heartbeat_stop();</a>
<a name="ln57">    app_log_purge_flash();</a>
<a name="ln58">    // Execution stops here normally</a>
<a name="ln59">    ri_power_enter_bootloader();</a>
<a name="ln60">    // Reset on fail to enter BL</a>
<a name="ln61">    ri_power_reset();</a>
<a name="ln62">}</a>
<a name="ln63"> </a>
<a name="ln64">#ifndef CEEDLING</a>
<a name="ln65">static</a>
<a name="ln66">#endif</a>
<a name="ln67">void button_timer_handler_isr (void * p_context)</a>
<a name="ln68">{</a>
<a name="ln69">    button_action_t * p_action = (button_action_t *) p_context;</a>
<a name="ln70">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln71"> </a>
<a name="ln72">    if (p_action-&gt;factory_reset)</a>
<a name="ln73">    {</a>
<a name="ln74">        err_code |= ri_scheduler_event_put (NULL, 0, &amp;factory_reset);</a>
<a name="ln75">    }</a>
<a name="ln76"> </a>
<a name="ln77">    RD_ERROR_CHECK (err_code, RD_SUCCESS);</a>
<a name="ln78">}</a>
<a name="ln79"> </a>
<a name="ln80">// Find which button was pressed</a>
<a name="ln81">#ifndef CEEDLING</a>
<a name="ln82">static</a>
<a name="ln83">#endif</a>
<a name="ln84">ri_gpio_slope_t get_activation (const ri_gpio_evt_t * const evt)</a>
<a name="ln85">{</a>
<a name="ln86">    size_t ii;</a>
<a name="ln87">    const ri_gpio_id_t buttons[] = RB_BUTTONS_LIST;</a>
<a name="ln88">    const ri_gpio_state_t states[] = RB_BUTTONS_ACTIVE_STATE;</a>
<a name="ln89">    ri_gpio_slope_t activation;</a>
<a name="ln90"> </a>
<a name="ln91">    for (ii = 0; (ii &lt; RB_BUTTONS_NUMBER) &amp;&amp; (buttons[ii] != evt-&gt;pin); ii++) {};</a>
<a name="ln92"> </a>
<a name="ln93">    if (ii &lt; RB_BUTTONS_NUMBER)</a>
<a name="ln94">    {</a>
<a name="ln95">        activation = (states[ii] == RI_GPIO_HIGH) ? RI_GPIO_SLOPE_LOTOHI :</a>
<a name="ln96">                     RI_GPIO_SLOPE_HITOLO;</a>
<a name="ln97">    }</a>
<a name="ln98">    else</a>
<a name="ln99">    {</a>
<a name="ln100">        activation = RI_GPIO_SLOPE_UNKNOWN;</a>
<a name="ln101">    }</a>
<a name="ln102"> </a>
<a name="ln103">    return activation;</a>
<a name="ln104">}</a>
<a name="ln105"> </a>
<a name="ln106">static void handle_enable_config_button (const bool activated)</a>
<a name="ln107">{</a>
<a name="ln108">    if (activated)</a>
<a name="ln109">    {</a>
<a name="ln110">        LOG (&quot;Config button pressed\r\n&quot;);</a>
<a name="ln111">        m_button_action.factory_reset = 1;</a>
<a name="ln112">        // Disable activity led to not turn off the button indication led.</a>
<a name="ln113">        app_led_activity_pause (true);</a>
<a name="ln114">        app_led_activate (RB_LED_BUTTON_PRESS);</a>
<a name="ln115">        ri_timer_stop (m_button_timer);</a>
<a name="ln116">        ri_timer_start (m_button_timer, APP_BUTTON_LONG_PRESS_TIME_MS, &amp;m_button_action);</a>
<a name="ln117">    }</a>
<a name="ln118">    else</a>
<a name="ln119">    {</a>
<a name="ln120">        LOG (&quot;Config button released\r\n&quot;);</a>
<a name="ln121">        m_button_action.factory_reset = 0;</a>
<a name="ln122">        app_led_deactivate (RB_LED_BUTTON_PRESS);</a>
<a name="ln123">        app_led_activity_pause (false);</a>
<a name="ln124">        (void) ri_timer_stop (m_button_timer);</a>
<a name="ln125">        (void) app_comms_configure_next_enable();</a>
<a name="ln126">    }</a>
<a name="ln127">}</a>
<a name="ln128"> </a>
<a name="ln129">#ifndef CEEDLING</a>
<a name="ln130">static</a>
<a name="ln131">#endif</a>
<a name="ln132">void button_handler (void * p_event_data, uint16_t event_size)</a>
<a name="ln133">{</a>
<a name="ln134">    if ( (NULL != p_event_data) &amp;&amp; (sizeof (ri_gpio_evt_t) == event_size))</a>
<a name="ln135">    {</a>
<a name="ln136">        const ri_gpio_evt_t * const p_evt = (ri_gpio_evt_t *) p_event_data;</a>
<a name="ln137">        const ri_gpio_slope_t activation = get_activation (p_evt);</a>
<a name="ln138"> </a>
<a name="ln139">        if (RB_BUTTON_ENABLE_CONFIG == p_evt-&gt;pin)</a>
<a name="ln140">        {</a>
<a name="ln141">            handle_enable_config_button (p_evt-&gt;slope == activation);</a>
<a name="ln142">        }</a>
<a name="ln143">    }</a>
<a name="ln144">}</a>
<a name="ln145"> </a>
<a name="ln146">#if RB_BUTTONS_NUMBER &gt; 0</a>
<a name="ln147">#ifndef CEEDLING</a>
<a name="ln148">static</a>
<a name="ln149">#endif</a>
<a name="ln150">void on_button_1_press_isr (const ri_gpio_evt_t evt)</a>
<a name="ln151">{</a>
<a name="ln152">    rd_status_t err_code = ri_scheduler_event_put (&amp;evt, sizeof (ri_gpio_evt_t),</a>
<a name="ln153">                           &amp;button_handler);</a>
<a name="ln154">    RD_ERROR_CHECK (err_code, ~RD_ERROR_FATAL);</a>
<a name="ln155">}</a>
<a name="ln156">#endif</a>
<a name="ln157"> </a>
<a name="ln158">#if RB_BUTTONS_NUMBER &gt; 1</a>
<a name="ln159">#ifndef CEEDLING</a>
<a name="ln160">static</a>
<a name="ln161">#endif</a>
<a name="ln162">void on_button_2_press (const ri_gpio_evt_t evt)</a>
<a name="ln163">{</a>
<a name="ln164">    ri_gpio_slope_t activation = get_activation (evt);</a>
<a name="ln165"> </a>
<a name="ln166">    if (activation == evt.slope)</a>
<a name="ln167">    {</a>
<a name="ln168">        LOG (&quot;Button 2 pressed\r\n&quot;);</a>
<a name="ln169">    }</a>
<a name="ln170">    else</a>
<a name="ln171">    {</a>
<a name="ln172">        LOG (&quot;Button 2 released\r\n&quot;);</a>
<a name="ln173">    }</a>
<a name="ln174">}</a>
<a name="ln175">#endif</a>
<a name="ln176"> </a>
<a name="ln177">#if RB_BUTTONS_NUMBER &gt; 2</a>
<a name="ln178">#ifndef CEEDLING</a>
<a name="ln179">static</a>
<a name="ln180">#endif</a>
<a name="ln181">void on_button_3_press (const ri_gpio_evt_t evt)</a>
<a name="ln182">{</a>
<a name="ln183">    ri_gpio_slope_t activation = get_activation (evt);</a>
<a name="ln184"> </a>
<a name="ln185">    if (activation == evt.slope)</a>
<a name="ln186">    {</a>
<a name="ln187">        LOG (&quot;Button 3 pressed\r\n&quot;);</a>
<a name="ln188">    }</a>
<a name="ln189">    else</a>
<a name="ln190">    {</a>
<a name="ln191">        LOG (&quot;Button 3 released\r\n&quot;);</a>
<a name="ln192">    }</a>
<a name="ln193">}</a>
<a name="ln194">#endif</a>
<a name="ln195"> </a>
<a name="ln196">#if RB_BUTTONS_NUMBER &gt; 3</a>
<a name="ln197">#ifndef CEEDLING</a>
<a name="ln198">static</a>
<a name="ln199">#endif</a>
<a name="ln200">void on_button_4_press (const ri_gpio_evt_t evt)</a>
<a name="ln201">{</a>
<a name="ln202">    ri_gpio_slope_t activation = get_activation (evt);</a>
<a name="ln203"> </a>
<a name="ln204">    if (activation == evt.slope)</a>
<a name="ln205">    {</a>
<a name="ln206">        LOG (&quot;Button 4 pressed\r\n&quot;);</a>
<a name="ln207">    }</a>
<a name="ln208">    else</a>
<a name="ln209">    {</a>
<a name="ln210">        LOG (&quot;Button 4 released\r\n&quot;);</a>
<a name="ln211">    }</a>
<a name="ln212">}</a>
<a name="ln213">#endif</a>
<a name="ln214"> </a>
<a name="ln215">/** @brief List of buttons to initialize. */</a>
<a name="ln216">static const ri_gpio_id_t button_pins[] = RB_BUTTONS_LIST;</a>
<a name="ln217">/** @brief GPIO states when button is considered active */</a>
<a name="ln218">static const ri_gpio_state_t button_active[] = RB_BUTTONS_ACTIVE_STATE;</a>
<a name="ln219">/** @brief Function callbacks on button presses. - TODO: Generalise for multiple buttons */</a>
<a name="ln220">static const rt_button_fp_t app_button_handlers[RB_BUTTONS_NUMBER] =</a>
<a name="ln221">{</a>
<a name="ln222">#if RB_BUTTONS_NUMBER &gt; 0</a>
<a name="ln223">    &amp; on_button_1_press_isr,</a>
<a name="ln224">#endif</a>
<a name="ln225">#if RB_BUTTONS_NUMBER &gt; 1</a>
<a name="ln226">    &amp; on_button_2_press_isr,</a>
<a name="ln227">#endif</a>
<a name="ln228">#if RB_BUTTONS_NUMBER &gt; 2</a>
<a name="ln229">    &amp; on_button_3_press_isr,</a>
<a name="ln230">#endif</a>
<a name="ln231">#if RB_BUTTONS_NUMBER &gt; 3</a>
<a name="ln232">    &amp; on_button_4_press_isr,</a>
<a name="ln233">#endif</a>
<a name="ln234">};</a>
<a name="ln235"> </a>
<a name="ln236">#ifndef CEEDLING</a>
<a name="ln237">static</a>
<a name="ln238">#endif</a>
<a name="ln239">rt_button_init_t m_init_data =</a>
<a name="ln240">{</a>
<a name="ln241">    .p_button_pins = button_pins,</a>
<a name="ln242">    .p_button_active = button_active,</a>
<a name="ln243">    .p_button_handlers = app_button_handlers,</a>
<a name="ln244">    .num_buttons = RB_BUTTONS_NUMBER</a>
<a name="ln245">};</a>
<a name="ln246"> </a>
<a name="ln247">/**</a>
<a name="ln248"> * @brief Initialize buttons.</a>
<a name="ln249"> *</a>
<a name="ln250"> * After initialization buttons are powered if needed and</a>
<a name="ln251"> * the callback defined at app_button.c is called on activation.</a>
<a name="ln252"> *</a>
<a name="ln253"> * @retval RD_SUCCESS if buttons were initialized</a>
<a name="ln254"> * @retval RD_ERROR_INVALID_STATE if RI_GPIO or RI_GPIO_INTERRUPT are not initialized.</a>
<a name="ln255"> */</a>
<a name="ln256">rd_status_t app_button_init (void)</a>
<a name="ln257">{</a>
<a name="ln258">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln259">#   if RB_BUTTON_PWR_PIN_NUMBER</a>
<a name="ln260">    ri_gpio_id_t button_pwr_pins[RB_BUTTON_PWR_PIN_NUMBER] = RB_BUTTON_PWR_PINS;</a>
<a name="ln261"> </a>
<a name="ln262">    for (size_t ii = 0; ii &lt; RB_BUTTON_PWR_PIN_NUMBER; ii++)</a>
<a name="ln263">    {</a>
<a name="ln264">        err_code |= ri_gpio_configure (button_pwr_pins[ii],</a>
<a name="ln265">                                       RI_GPIO_MODE_OUTPUT_HIGHDRIVE);</a>
<a name="ln266">        err_code |= ri_gpio_write (button_pwr_pins[ii], RI_GPIO_HIGH);</a>
<a name="ln267">    }</a>
<a name="ln268"> </a>
<a name="ln269">#   endif</a>
<a name="ln270">    err_code |= ri_timer_create (&amp;m_button_timer, RI_TIMER_MODE_SINGLE_SHOT,</a>
<a name="ln271">                                 &amp;button_timer_handler_isr);</a>
<a name="ln272">    err_code |= rt_button_init (&amp;m_init_data);</a>
<a name="ln273">    return err_code;</a>
<a name="ln274">}</a>
<a name="ln275"> </a>
<a name="ln276">#else</a>
<a name="ln277">rd_status_t app_button_init (void)</a>
<a name="ln278">{</a>
<a name="ln279">    return RD_SUCCESS;</a>
<a name="ln280">}</a>
<a name="ln281">#endif</a>
<a name="ln282"> </a>
<a name="ln283">/** @} */</a>

</code></pre>
<div class="balloon" rel="52"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'event_size'.</p></div>
<div class="balloon" rel="52"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2537/" target="_blank">V2537</a> Functions should not have unused parameters. Consider inspecting the parameter: 'p_event_data'.</p></div>
<div class="balloon" rel="69"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2571/" target="_blank">V2571</a> Pointer to void should not be converted to a pointer to object. Consider inspecting the expression: '(button_action_t *) p_context'.</p></div>
<div class="balloon" rel="87"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="91"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="91"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '<' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="91"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1008/" target="_blank">V1008</a> Consider inspecting the 'for' operator. No more than one iteration of the loop will be performed.</p></div>
<div class="balloon" rel="93"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '<' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="95"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'signed' type to the essential 'ri_gpio_slope_t' type.</p></div>
<div class="balloon" rel="111"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="114"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="121"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="122"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="136"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2571/" target="_blank">V2571</a> Pointer to void should not be converted to a pointer to object. Consider inspecting the expression: '(ri_gpio_evt_t *) p_event_data'.</p></div>
<div class="balloon" rel="139"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>
<div class="balloon" rel="139"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '==' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="216"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2544/" target="_blank">V2544</a> The left operand '(0)' of the '<<' operator should not have the essential 'signed' type.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
